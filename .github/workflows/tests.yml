name: Tests

on:
  push:
    branches: [ main, staging ]
  pull_request:
    branches: [ main, staging ]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    env:
      NODE_ENV: test
      NODE_OPTIONS: --experimental-vm-modules
      DATABASE_URL: postgresql://test:test@localhost:5432/test_db
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run tests
      id: test
      run: |
        npm test 2>&1 | tee test-output.log
        TEST_EXIT_CODE=${PIPESTATUS[0]}
        
        if [ $TEST_EXIT_CODE -eq 0 ]; then
          echo "status=success" >> $GITHUB_OUTPUT
          echo "## âœ… Tests Passed" >> $GITHUB_STEP_SUMMARY
          echo "All tests completed successfully!" >> $GITHUB_STEP_SUMMARY
        else
          echo "status=failed" >> $GITHUB_OUTPUT
          echo "## âŒ Tests Failed" >> $GITHUB_STEP_SUMMARY
          echo "Some tests failed. Check the logs for details." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Failed Test Output:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          tail -n 50 test-output.log >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        fi
        
        exit $TEST_EXIT_CODE
      continue-on-error: false
      
    - name: Upload coverage reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-reports
        path: coverage/
        retention-days: 30
        
    - name: Add test failure annotations
      if: failure() && steps.test.outputs.status == 'failed'
      run: |
        echo "::error::Tests failed. Check the test output above for specific failure details."
        
    - name: Update step summary with coverage
      if: always()
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Coverage Information" >> $GITHUB_STEP_SUMMARY
        if [ -f coverage/lcov-report/index.html ]; then
          echo "Coverage reports have been generated and uploaded as artifacts." >> $GITHUB_STEP_SUMMARY
        else
          echo "No coverage reports found." >> $GITHUB_STEP_SUMMARY
        fi